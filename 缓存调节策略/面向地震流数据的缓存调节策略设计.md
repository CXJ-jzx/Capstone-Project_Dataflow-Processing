# 🚀 面向地震流数据的自适应缓存调节机制设计与实现

**项目阶段：** 缓存调节策略设计（理论与架构）

**核心技术：** Apache Flink Keyed State, JVM LinkedHashMap, RocketMQ

---

## 📚 第一阶段：理论基础与场景定义

### 1.1 研究背景：地震数据的时空局部性
地震勘探数据采集具有典型的 **时空局部性（Spatio-Temporal Locality）** 特征，这是设计高效缓存策略的物理基础。

* **⏱️ 时间局部性 (Temporal Locality)：** 同一传感器连续采集的数据在短时间内具有高度相关性（如稳定的背景噪声）。
* **🌍 空间局部性 (Spatial Locality)：** 地理位置接近的传感器数据在同一时刻往往高度相似。

### 1.2 核心设计目标
本缓存机制旨在解决野外网络带宽受限和数据传输冗余问题：

1.  **⬇️ 降低网络传输负载：** 通过缓存实现数据去重或差分传输。
2.  **📈 提高资源利用率：** 基于内存负载动态调节缓存容量。
3.  **⚡ 保证实时性：** 减少 RocksDB 访问，将缓存查找延迟控制在最低。

---

## 🏗️ 2. 整体架构设计：双层缓存结构（修订版）

为兼顾高性能（ $O(1)$ 访问）与高可靠性（容错），采用 **“双层缓存结构”**。

### 2.1 缓存分层结构

| 层级 | 存储位置 | 职责核心 | 关键特性 |
| :--- | :--- | :--- | :--- |
| **一级缓存** | TaskManager JVM 堆内存 | 高频数据快速访问、性能加速 | $O(1)$ 读写，非容错 |
| **二级缓存** | Flink Keyed State (RocksDB) | 容错恢复、状态持久化 | 容错能力强，性能次之 |

---
> L2缓存基于Flink KeyedState，并在 RocksDBStateBackend 下自动持久化为 RocksDB Column Family，由 RocksDB 内部的 MemTable + WAL + SSTable 结构管理。
---



### 2.2 缓存访问流程设计
数据访问遵循 **写穿透（Write-Through）** 和 **回填（Cache-Aside Read）** 机制：

1.  **新数据到达** $\rightarrow$ 生成特征 Hash Key。
2.  **查一级缓存 (JVM)**：
    * **命中** $\rightarrow$ 直接输出引用/结果（**高性能**）。
    * **未命中** $\rightarrow$ 查二级缓存 (RocksDB)。
3.  **查二级缓存 (RocksDB)**：
    * **命中** $\rightarrow$ 回填一级缓存 $\rightarrow$ 输出。
    * **未命中** $\rightarrow$ 执行真实计算 $\rightarrow$ 写入一级缓存 $\rightarrow$ **同步更新二级缓存**（写穿透）。
4.  **输出结果**：向下游算子发送精简后的数据或计算结果。

---

## 🧱 3. 缓存数据结构与策略

### 3.1 缓存数据结构
| 结构名称 | Flink 状态类型 | 作用 |
| :--- | :--- | :--- |
| **一级缓存** | Java `LinkedHashMap` | 存储缓存实体，利用 `accessOrder=true` 实现 $O(1)$ LRU 淘汰。 |
| **二级缓存** | `MapState<String, FeatureValue>` | 存储实际缓存数据的持久化副本。 |
| **容量状态** | `ValueState<Integer>` | 存储当前允许的最大容量 $currentCapacity$，用于容错恢复。 |

### 3.2 淘汰策略：LRU
* **基线策略：** 利用 `LinkedHashMap` 的内置 LRU 特性，当条目数超过 `currentCapacity` 时，自动移除最久未访问的 Key。

---

## ⚖️ 4. 动态容量调节机制

### 4.1 关键监控指标
系统通过 Flink Metrics 实时采集以下指标作为调节依据：

1.  **命中率 ($HR$):** $$HR = \frac{Hits}{Hits + Misses}$$
2.  **堆内存负载 ($Mem_{load}$):** TaskManager 当前 JVM Heap 使用率。

### 4.2 双阈值 + 冷却时间调节策略
调节目标是平衡 $HR$（缓存收益）和 $\text{Mem}_{load}$（资源消耗），通过调整 $\text{capacityState}$ 实现。

| 系统状态 | 触发条件 | 调节动作 | 策略解释 |
| :--- | :--- | :--- | :--- |
| **⬆️ 扩容模式** | $HR > T_{high}$ 且 $Mem_{load} < M_{safe}$ | $\text{capacity} = \text{capacity} \times 1.2$ | 缓存有效且内存充裕，扩大容量以提高命中率。 |
| **⬇️ 缩容模式** | $HR < T_{low}$ 且 $Mem_{load} < M_{safe}$ | $\text{capacity} = \text{capacity} \times 0.8$ | 缓存收益低，释放资源。 |
| **🚨 保护模式** | $$Mem_{load} > M_{danger}$$ | $\text{capacity} = \text{capacity} \times 0.5$ | **高优先级**：内存告警，强制大幅缩容防 OOM。 |

**防抖机制：** 引入 **冷却时间 (Cooldown)**，在两次真实的扩缩容操作之间强制等待，防止系统在阈值附近频繁抖动。

---

## 🌐 5. 面向地震数据特性的优化

### 5.1 地震数据语义感知缓存原则
在基线 LRU 基础上，引入语义权重，优化淘汰决策：
```text
if Amplitude > Critical_Threshold:
    // 优先保留有效信号的上下文，使其不易被 LRU 淘汰
    强制提升缓存优先级（例如更新其访问时间戳）
else:
    // 背景噪声等低价值数据，遵循标准 LRU 淘汰
    遵循标准 LRU 策略
```


## 🧪 6. 可行的实验验证方案设计

本研究设计三组对比实验，以科学、量化地评估自适应缓存调节策略（本文方案）在不同负载下的性能优势和资源优化效果。

### 6.1 实验组设置

| 实验编号 | 模式 | 目的 |
| :--- | :--- | :--- |
| **EXP-1** | 无缓存 (Baseline) | 作为性能基线，衡量引入缓存前的原始系统性能。 |
| **EXP-2** | 固定容量 LRU 缓存 | 对比固定容量策略与自适应容量策略在资源和效率上的差异。 |
| **EXP-3** | **自适应容量缓存**（本文方案） | 验证动态调节机制在数据流量和内存负载波动下的资源优化效果。 |

### 6.2 关键评估指标

为全面评估系统的性能、资源利用率和可靠性，将采集以下核心指标：

| 指标类别 | 评估指标 | 目标趋势 | 意义 |
| :--- | :--- | :--- | :--- |
| **有效性** | **缓存命中率 (HR)** | 📈 越高越好 | 反映缓存对地震数据时空局部性的利用程度。 |
| **资源消耗** | **网络出口带宽占用** | 📉 越低越好 | 反映冗余消除和差分传输的实际效果，缓解野外网络瓶颈。 |
| **性能** | **平均处理延迟** | 📉 越低越好 | 衡量缓存查找（$O(1)$）对整体流处理实时性的影响。 |
| **系统开销** | **RocksDB 访问次数 (I/O)** | 📉 越低越好 | 衡量一级 JVM 本地缓存的效率，反映对后端存储的减负效果。 |
| **稳定性** | **TaskManager CPU/内存负载** | 📈 保持稳定 | 验证动态容量调节在高峰负载下防止资源耗尽的能力。 |

---

## ✅ 7. 本阶段成果与下一步工作

### 7.1 本阶段成果定义

本阶段机制实现成功，需满足以下所有技术点：

* 支持 **JVM 本地缓存**（基于 `LinkedHashMap`）。
* 支持 **LRU 淘汰** 策略。
* 支持 **动态容量调节** 机制（基于双阈值反馈）。
* 支持 **Keyed State 容错恢复**（二级缓存）。
* 支持 Flink **Metrics** 监控（HR, $\text{Mem}_{load}$）。

### 7.2 下一步工作路径

接下来的工作将进入编码实现和实验验证阶段：

1.  **代码框架构建：** 编写 `Cache Operator` 基础代码框架，实现双层缓存的读写逻辑，并完成与 Keyed State 的双向同步。
2.  **Metrics 与控制流：** 接入 Flink Metrics 接口，编写动态调节逻辑代码，并实现容量状态的修改与更新。
3.  **数据与验证：** 构建地震数据模拟器，准备具有不同重复率和负载波动的测试数据，用于三组对比实验。
