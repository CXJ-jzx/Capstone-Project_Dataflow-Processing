# 🚀 第一阶段：设计缓存场景与策略（理论准备）

本章节详细记录了面向地震流数据缓存调节策略的理论基础、应用场景定义及核心算法设计。该设计旨在利用地震数据的时空局部性特征，在 Flink 流处理系统中实现智能缓存与动态调节。

---

## 📚 1. 研究背景与设计目标

### 1.1 研究背景：地震数据的时空局部性
地震勘探数据（Seismic Trace Data）的采集具有典型的 **时空局部性（Spatio-Temporal Locality）** 特征，这是设计高效缓存策略的物理基础。

* **⏱️ 时间局部性 (Temporal Locality)：** 同一传感器（Geophone）在连续的毫秒级时间窗内，其采集到的数据（尤其是背景噪声或稳定信号）往往具有高度相关性或重复性。
* **🌍 空间局部性 (Spatial Locality)：** 地理位置接近的传感器节点，其在同一激发时刻采集到的波形特征具有高度相似性。

### 1.2 核心设计目标
针对野外网络带宽受限和数据传输冗余问题，本缓存调节机制的设计目标如下：

1.  **⬇️ 降低网络传输负载：** 通过缓存中间结果或特征，实现数据去重或差分传输。
2.  **📈 提高资源利用率：** 动态调节缓存容量，合理利用 Flink TaskManager 的堆内存资源。
3.  **⚡ 保证实时性：** 确保缓存查询/写入操作的延迟远低于网络传输延迟。

---

## ⚙️ 2. 缓存场景与作用机制

### 2.1 选定的应用场景：基于特征的冗余消除
本研究选择在 Flink 流处理算子内部实现 **“基于历史特征的冗余消除（Redundancy Elimination）”** 机制。

| 核心要素 | 详细描述 | 设计目的 |
| :--- | :--- | :--- |
| **位置** | `KeyedProcessFunction` 内部的 **Flink 状态** (State) | 利用 Flink 的 Checkpoint 容错机制。 |
| **对象** | 传感器 $S_i$ 在 $T_j$ 时刻的 **特征向量** 或 **波形指纹** | 仅存储特征而非原始波形，最小化内存占用。 |
| **逻辑** | 1. **提取：** 对新数据提取特征 $F_{new}$。<br>2. **比对：** 在 State 中查找是否已存在相似特征。<br>3. **命中：** 仅向下游发送引用 ID (Flag)。<br>4. **未命中：** 发送完整数据，并更新 State。 | 拦截重复或高度相似的数据帧，实现流量削峰。 |

### 2.2 数据流交互示意图


> 图说明：原始数据流进入 CacheOperator，经过特征提取与缓存匹配后，分为“完整数据流”与“轻量级引用流”输出，从而降低网络压力。

---

## 🔬 3. 缓存策略与算法设计

### 3.1 缓存数据结构设计 (Flink State)
为了支持动态调节与容错，缓存层构建在 Flink 的 Keyed State 之上：

* **数据存储 (Data Store):** `MapState<String, FeatureValue>`
    * **Key:** 特征哈希值 (Hash)。
    * **Value:** 对应的历史特征数据。
* **访问追踪 (Usage Tracking):** `MapState<String, Long>`
    * **Value:** 最近一次访问的时间戳 (Process Time)，用于 LRU 计算。
* **动态容量 (Dynamic Capacity):** `ValueState<Integer>`
    * **Value:** 当前算子允许的最大缓存条目数 `currentCapacity`。**此参数由调节策略动态控制。**

### 3.2 淘汰算法 (Eviction Policy)
采用 **LRU (Least Recently Used)** 策略管理有限的堆内存资源：
* **🔑 触发条件：** 当 `MapState` 中的条目数量超过 `currentCapacity` 时触发。
* **🗑️ 执行动作：** 寻找时间戳最小（最久未被使用）的 Key 进行删除。

---

## ⚖️ 4. 动态调节机制 (Regulation Mechanism)

### 4.1 关键监控指标
系统通过 Metrics 实时采集以下指标作为调节依据：
1.  **命中率 ($HR$):** $$HR = \frac{Hits}{Hits + Misses}$$
2.  **堆内存负载 ($Mem_{load}$):** TaskManager 当前 JVM Heap 使用率。

### 4.2 双阈值动态容量调节策略
设计反馈控制循环，根据实时负载调整 `currentCapacity`：

| 系统状态 | 判定条件 | 调节动作 | 策略解释 |
| :--- | :--- | :--- | :--- |
| **⬆️ 扩张期** | $HR > T_{high}$ 且 $Mem_{load} < M_{safe}$ | 容量 $\times 1.2$ | 命中率高且内存充裕，扩大缓存以捕获更多重复模式。 |
| **⬇️ 收缩期** | $HR < T_{low}$ 且 $Mem_{load} < M_{safe}$ | 容量 $\times 0.8$ | 缓存收益低，释放内存资源给计算任务。 |
| **🚨 保护期** | $Mem_{load} > M_{danger}$ | 容量 $\times 0.5$ | **高优先级**：内存告警，强制大幅缩容以防止节点崩溃。 |
| **✅ 稳定期** | 其他情况 | 保持不变 | 避免频繁抖动带来的性能开销。 |

---

## 🗓️ 5. 总结与后续计划
本阶段完成了缓存调节策略的理论框架构建。确定了以 **KeyedProcessFunction** 为载体，结合 **LRU 淘汰算法** 与 **资源感知动态调节** 的技术路线。

**下一步工作：**
1.  搭建 Flink 自定义算子开发环境。
2.  实现基础的 LRU 缓存功能。
3.  接入 Metrics 监控，编写动态调节逻辑代码。
